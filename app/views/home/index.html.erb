<div class="three-pane-layout"
     data-controller="keyboard selection pin help-dialog mobile-pane"
     data-pin-selection-outlet=".three-pane-layout"
     data-mobile-pane="feeds"
     data-action="keyboard:next-entry->selection#nextEntry
                  keyboard:previous-entry->selection#previousEntry
                  keyboard:next-feed->selection#nextFeed
                  keyboard:previous-feed->selection#previousFeed
                  keyboard:scroll-entry-detail-down->selection#scrollEntryDetailDown
                  keyboard:scroll-entry-detail-up->selection#scrollEntryDetailUp
                  keyboard:open-entry-in-new-tab->selection#openEntryInNewTab
                  keyboard:toggle-pin->pin#togglePin
                  keyboard:open-pinned->pin#openPinned
                  keyboard:mark-all-as-read->selection#markAllAsRead
                  keyboard:reload-page->selection#reloadPage
                  keyboard:open-hatena-bookmark->selection#openHatenaBookmark
                  keyboard:open-hatena-bookmark-add->selection#openHatenaBookmarkAdd
                  keyboard:toggle-help->help-dialog#toggle">
  <!-- Left pane: Feed list -->
  <aside class="feed-list-pane">
    <div class="pane-header">
      <h1>Tsubame</h1>
      <div class="pane-header-links">
        <%= link_to pinned_entries_path, data: { turbo_frame: "entry_list" }, class: "pin-list-link" do %>
          📌 ピン一覧
          <span id="pin_badge">
            <% if @pinned_count > 0 %>
              <span class="pin-badge"><%= @pinned_count %></span>
            <% end %>
          </span>
        <% end %>
        <%= link_to "フィード管理", feeds_path, class: "feed-manage-link" %>
        <%= link_to "フォルダ管理", folders_path, class: "feed-manage-link" %>
        <%= link_to "パスワード変更", edit_password_path, class: "feed-manage-link" %>
        <button type="button" class="reload-button" aria-label="ページ再読み込み" title="ページ再読み込み (r)" data-action="click->selection#reloadPage">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"></polyline>
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
          </svg>
        </button>
      </div>
    </div>

    <nav class="rate-filter" aria-label="レートフィルター">
      <%= link_to "すべて", root_path,
          class: "rate-filter-link #{"rate-filter-link--active" if @rate == 0}",
          aria: { current: @rate == 0 || nil } %>
      <% (1..5).each do |n| %>
        <%= link_to "#{"★" * n}以上", root_path(rate: n),
            class: "rate-filter-link #{"rate-filter-link--active" if @rate == n}",
            aria: { current: @rate == n || nil } %>
      <% end %>
    </nav>

    <div class="feed-list" data-selection-target="feedList">
      <% if @feeds.any? %>
        <% @grouped_feeds.each do |folder, feeds| %>
          <div class="feed-folder-header"><%= folder&.name || "未分類" %></div>
          <% feeds.each do |feed| %>
            <%= link_to feed_entries_path(feed), data: { turbo_frame: "entry_list", feed_id: feed.id }, class: "feed-item", tabindex: "-1" do %>
              <span class="feed-title"><%= feed.title || feed.url %></span>
              <% if feed.unread_count > 0 %>
                <span class="unread-badge"><%= feed.unread_count %></span>
              <% end %>
            <% end %>
          <% end %>
        <% end %>
      <% else %>
        <p class="empty-message">フィードがありません。<%= link_to "OPMLをインポート", new_feed_import_path %>してください。</p>
      <% end %>
    </div>
  </aside>

  <!-- Right pane: Entry list and detail -->
  <div class="content-pane">
    <!-- Top: Entry list -->
    <section class="entry-list-pane" data-selection-target="entryList">
      <%= turbo_frame_tag "entry_list" do %>
        <div class="empty-message">
          <p>左からフィードを選択してください</p>
        </div>
      <% end %>
    </section>

    <!-- Bottom: Entry detail -->
    <section class="entry-detail-pane" data-selection-target="entryDetail">
      <%= turbo_frame_tag "entry_detail" do %>
        <div class="empty-message">
          <p>エントリを選択してください</p>
        </div>
      <% end %>
    </section>
  </div>

  <dialog class="help-dialog" data-help-dialog-target="dialog">
    <div class="help-dialog-header">
      <h2>キーボードショートカット</h2>
      <button class="help-dialog-close" aria-label="ヘルプを閉じる" data-action="click->help-dialog#close">✕</button>
    </div>

    <h3>フィードナビゲーション</h3>
    <table>
      <tbody>
        <tr><td><kbd>s</kbd></td><td>次のフィード</td></tr>
        <tr><td><kbd>a</kbd></td><td>前のフィード</td></tr>
        <tr><td><kbd>r</kbd></td><td>ページ再読み込み</td></tr>
      </tbody>
    </table>

    <h3>エントリナビゲーション</h3>
    <table>
      <tbody>
        <tr><td><kbd>j</kbd></td><td>次のエントリ</td></tr>
        <tr><td><kbd>k</kbd></td><td>前のエントリ</td></tr>
        <tr><td><kbd>Space</kbd></td><td>エントリ詳細をスクロールダウン</td></tr>
        <tr><td><kbd>Shift+Space</kbd></td><td>エントリ詳細をスクロールアップ</td></tr>
      </tbody>
    </table>

    <h3>アクション</h3>
    <table>
      <tbody>
        <tr><td><kbd>v</kbd></td><td>エントリを新タブで開く</td></tr>
        <tr><td><kbd>p</kbd></td><td>ピン追加/解除</td></tr>
        <tr><td><kbd>o</kbd></td><td>ピン留めエントリを新タブで開く</td></tr>
        <tr><td><kbd>Shift+A</kbd></td><td>現在のフィードを全既読</td></tr>
        <tr><td><kbd>b</kbd></td><td>はてなブックマークページを開く</td></tr>
        <tr><td><kbd>h</kbd></td><td>はてなブックマークに追加</td></tr>
      </tbody>
    </table>

    <h3>その他</h3>
    <table>
      <tbody>
        <tr><td><kbd>?</kbd></td><td>このヘルプを表示/非表示</td></tr>
      </tbody>
    </table>
  </dialog>
</div>
